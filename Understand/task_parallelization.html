
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Task Parallelization &#8212; Smilei 5.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/smilei_theme.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/smileiIcon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Syntax changes" href="../syntax_changes.html" />
    <link rel="prev" title="Optimization and vectorization compilation options" href="../Use/optimization_flags.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
      scale: 95,
      availableFonts: ["TeX"]
    }
  });
  </script>
   
  </head><body>

<div id="smallScreenMenu" class="off">

    
    <div class="toctree-smilei">
        <ul>
            <li class="outer">
                <a href="../Overview/synopsis.html">Synopsis</a>
            </li>
            <li class="outer">
                <a href="../Overview/highlights.html">Highlights</a>
            </li>
            <li class="outer">
                <a href="../Overview/releases.html">Releases</a>
            </li>
            <li class="outer">
                <a href="../Overview/licence.html">Licence</a>
            </li>
            <li class="outer">
                <a href="../Overview/material.html">Publications</a>
            </li>
            <li class="outer">
                <a href="../Overview/partners.html">Partners</a>
            </li>
        </ul>
        <hr />
        <ul>
            <li class="outer">
                <a href="units.html">Units</a>
            </li>
            <li class="outer">
                <a href="algorithms.html">PIC algorithms</a>
            </li>
            <li class="outer">
                <a href="performances.html">Parallelization & optimization</a>
            </li>
            <li class="outer">
                <a href="physics_modules.html">Physics modules</a>
            </li>
            <li class="outer">
                <a href="numerical_techniques.html">Advanced numerical techniques</a>
            </li>
            <li class="outer">
                <a href="PML.html">Perfectly Matched Layers</a>
            </li>
        </ul>
        <hr />
        <ul>
            <li class="outer">
                <a href="../Use/installation.html">Install</a>
            </li>
            <li class="outer">
                <a href="https://smileipic.github.io/tutorials">Smilei tutorials</a>
            </li>
            <li class="outer">
                <a href="../Use/namelist.html">Write a namelist</a>
            </li>
            <li class="outer">
                <a href="../Use/run.html">Run</a>
            </li>
            <li class="outer">
                <a href="../Use/post-processing.html">Post-process</a>
            </li>
            <li class="outer">
                <a href="../Use/contribute.html">Contribute</a>
            </li>
            <li class="outer">
                <a href="../Use/troubleshoot.html">Troubleshoot</a>
            </li>
            <li class="outer">
                <a href="../Use/GPU_version.html">GPU version of SMILEI</a>
            </li>
        </ul>
        <hr />
    </div>

</div>
<div id="hcontainer">
    <div id="nav_positioner">
        <div id="nav">
            <div id="nav_button" onclick="toggleNav()">
                Sections
            </div>
            <div id="nav_list" class="toctree-smilei">
                <div id="nav_title"><a href="#">Task Parallelization</a></div>
                <ul>
<li><a class="reference internal" href="#">Task Parallelization</a><ul>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#task-approach">Task approach</a></li>
<li><a class="reference internal" href="#task-dependency-graph">Task dependency graph</a></li>
<li><a class="reference internal" href="#performance-results">Performance Results</a></li>
</ul>
</li>
</ul>

            </div>
        </div>
    </div>
    
    <div class="headercolor">
    </div>
    <div class="hpositioner">
        <div class="header">
        <div class="logo">
            <a href="../index.html">
                <img class="logo" src="../_static/smileiLogo.svg" alt="Logo" />
            </a>
            <div style="height:7mm; position: absolute; top:2mm; left:-32mm; padding: 1mm 2mm 0 2mm; border-radius: 2mm; background-color:#C5DCEA; background-color:var(--header_text);">
                <a href="https://indico.math.cnrs.fr/e/smilei5">
                    <img src="../_static/workshopLogo.svg" alt="workshop"
                        style="height:5mm;padding-top: 1mm;" />
                </a>
            </div>
        </div>
        <div class="menu"
            id="menu_Overview"
            
        >
            <div id="menuButton_Overview" class="menuButton"
                 onmouseenter="prepareMenu('menu_Overview')"
                 onmousedown="event.preventDefault()"
            >
                <a href="../overview.html">
                    <span>Overview</span>
                </a>
            </div>
            <div class="off" onmouseleave="leaveMenu('menu_Overview',this)">
                <div class="toctree-smilei">
                    <ul>
                        <li class="outer">
                            <a href="../Overview/synopsis.html">Synopsis</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/highlights.html">Highlights</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/releases.html">Releases</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/licence.html">Licence</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/material.html">Publications</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/partners.html">Partners</a>
                        </li>
        
                    </ul>
                </div>
            </div>
        </div>
        <div class="menu"
            id="menu_Understand"
            
        >
            <div id="menuButton_Understand" class="menuButton"
                 onmouseenter="prepareMenu('menu_Understand')"
                 onmousedown="event.preventDefault()"
            >
                <a href="../understand.html">
                    <span>Understand</span>
                </a>
            </div>
            <div class="off" onmouseleave="leaveMenu('menu_Understand',this)">
                <div class="toctree-smilei">
                    <ul>
                        <li class="outer">
                            <a href="units.html">Units</a>
                        </li>
                        <li class="outer">
                            <a href="algorithms.html">PIC algorithms</a>
                        </li>
                        <li class="outer">
                            <a href="performances.html">Parallelization & optimization</a>
                        </li>
                        <li class="outer">
                            <a href="physics_modules.html">Physics modules</a>
                        </li>
                        <li class="outer">
                            <a href="numerical_techniques.html">Advanced numerical techniques</a>
                        </li>
                        <li class="outer">
                            <a href="PML.html">Perfectly Matched Layers</a>
                        </li>
        
                    </ul>
                </div>
            </div>
        </div>
        <div class="last menu"
            id="menu_Use"
            
        >
            <div id="menuButton_Use" class="menuButton"
                 onmouseenter="prepareMenu('menu_Use')"
                 onmousedown="event.preventDefault()"
            >
                <a href="../use.html">
                    <span>Use</span>
                </a>
            </div>
            <div class="off" onmouseleave="leaveMenu('menu_Use',this)">
                <div class="toctree-smilei">
                    <ul>
                        <li class="outer">
                            <a href="../Use/installation.html">Install</a>
                        </li>
                        <li class="outer">
                            <a href="https://smileipic.github.io/tutorials">Smilei tutorials</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/namelist.html">Write a namelist</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/run.html">Run</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/post-processing.html">Post-process</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/contribute.html">Contribute</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/troubleshoot.html">Troubleshoot</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/GPU_version.html">GPU version of SMILEI</a>
                        </li>
        
                    </ul>
                </div>
            </div>
        </div>
        
        <script type="text/javascript">
            var es=document.getElementsByClassName("menuButton"), i=0;
            var evt = "ontouchend" in document ? "touchend" : "click";
            for( var i=0; i<es.length; i+=1 ) {
                es[i].addEventListener(evt, function(a){ return function(){toggleMenu(a)};}(es[i].parentNode.id));
            }
        </script>
        
        <div id="searchbox" role="search" style="display:none">
            <form class="search" action="../search.html" method="get">
              <input type="text" name="q" placeholder="Search" id="searchinput" />
              <input type="hidden" name="check_keywords" value="yes" />
              <input type="hidden" name="area" value="default" />
            </form>
        </div>
        
        <div id="searchicon" onclick="openSearch()" style="display:block">
            <svg
               xmlns="http://www.w3.org/2000/svg"
               viewBox="0 0 80 120">
              <g transform="translate(0,-932.36216)" >
                <circle
                   r="25" cy="977.51044" cx="38.078663"
                   style="opacity:1;fill:none;stroke:#ffffff;stroke:var(--header_text);stroke-width:10;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
                <rect
                   transform="matrix(0.36717877,0.93015039,-0.93427297,0.35655858,0,0)"
                   rx="4.9996676" ry="7.4995141" x="947.6142" y="316.16959"
                   height="14.117695" width="46.476151"
                   style="opacity:1;fill:#ffffff;fill:var(--header_text);fill-opacity:1;stroke:none;" />
                <path
                   d="m 41.383282,962.25996 a 15,15 0 0 1 11.660107,11.6355"
                   style="opacity:1;fill:none;stroke:#ffffff;stroke:var(--header_text);stroke-width:3;stroke-linecap:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
              </g>
            </svg>
        </div>
        <div id="closesearchicon" onclick="closeSearch()" style="display:none">
            <svg
               xmlns="http://www.w3.org/2000/svg"
               viewBox="0 0 80 120">
              <g
                 transform="translate(0,-932.36216)"
                 style="fill:none;stroke:#ffffff;stroke:var(--header_text);stroke-width:10;stroke-linecap:round;stroke-linejoin:miter;stroke-opacity:1;stroke-miterlimit:4;stroke-dasharray:none">
                <path d="m 10,962.36216 60,60.00004" />
                <path d="M 70,962.36216 10,1022.3622" />
              </g>
            </svg>
        </div>
        
        <div id="smallScreenMenuButton" onclick="event.preventDefault(); toggleSmallScreenMenu(event)">
            <svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
               viewBox="-20 -20 140 140">
              <g  style="fill:#ffffff; fill:var(--header_text);stroke:none;">
                <circle cx="15" cy="20" r="5" />
                <circle cx="35" cy="20" r="5" />
                <circle cx="85" cy="20" r="5" />
                <rect width="50" height="10" x="35" y="15" rx="0" ry="0" />
                <circle cx="15" cy="40" r="5" />
                <circle cx="35" cy="40" r="5" />
                <circle cx="85" cy="40" r="5" />
                <rect width="50" height="10" x="35" y="35" rx="0" ry="0" />
                <circle cx="15" cy="60" r="5" />
                <circle cx="35" cy="60" r="5" />
                <circle cx="85" cy="60" r="5" />
                <rect width="50" height="10" x="35" y="55" rx="0" ry="0" />
                <circle cx="15" cy="80" r="5" />
                <circle cx="35" cy="80" r="5" />
                <circle cx="85" cy="80" r="5" />
                <rect width="50" height="10" x="35" y="75" rx="0" ry="0" />
              </g>
            </svg>
        </div>
        
    </div>
    
</div>
</div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="task-parallelization">
<h1>Task Parallelization<a class="headerlink" href="#task-parallelization" title="Permalink to this headline">¶</a></h1>
<p>Task parallelization is a method to spread the computing workload on the many cores
of a computer. Instead of splitting the <em>data</em> accross cores and apply the same task
to all these pieces, different <em>tasks</em> are split accross the cores with the
data necessary to complete them. This approach can often make the computation faster,
especially with non-uniform plasma distributions.</p>
<p>Task parallelization of macro-particle operations in Smilei (using OpenMP) is
published in <a class="reference internal" href="../Overview/material.html#massimo2022" id="id1"><span>[Massimo2022]</span></a>.</p>
<hr class="docutils" />
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>Usually, most of the computing time is spent on macro-particle operations.
Consequently, a non-uniform plasma distribution results in load imbalance:
some cpu cores are loaded with less macro-particles, and idly wait for the
other cores to finish their work.</p>
<p>Worse: adding more cpu cores will not result in significant speedup, as only
a few of them are performing most of the work. This “strong scaling” curve
(speed-up vs number of cpu-cores) starts to saturate. Several methods for
parallelism can increase the number of computing units where
the saturation occurs.</p>
<p>In <strong class="program">Smilei</strong>, by default, the data is split in <em>patches</em> (see
<a class="reference internal" href="parallelization.html"><span class="doc">Parallelization basics</span></a>) and, when the environment variable <code class="docutils literal notranslate"><span class="pre">OMP_SCHEDULE</span></code>
is set to <code class="docutils literal notranslate"><span class="pre">dynamic</span></code>, the OpenMP scheduler dynamically assigns each patch
to each core. This provides for some load balancing inside each MPI process, as
cores can work asynchronously on different patches.</p>
<p>This strategy implies that only 1 OpenMP thread can work on a given patch,
which includes potentially several <code class="docutils literal notranslate"><span class="pre">Species</span></code> and all the PIC operators
(interpolation, push, etc). These constraints can considerably slow down the
simulation in some situations (many species with non-uniform distribution,
and/or low number of patches per core).</p>
<p>A first solution is to split the data to a finer level: separate the
treatment of species, and split the patch in smaller structures (in Smilei,
patches are divided in <code class="docutils literal notranslate"><span class="pre">clusters</span></code> along the dimension <code class="docutils literal notranslate"><span class="pre">x</span></code>). This
can improve the strong scaling results, but some constructs cannot be
parallelized with this data splitting (e.g. irregularly nested loops, recursion,
etc). The task parallelism has been introduced to answer these issues.</p>
</section>
<hr class="docutils" />
<section id="task-approach">
<h2>Task approach<a class="headerlink" href="#task-approach" title="Permalink to this headline">¶</a></h2>
<p><strong class="program">Smilei</strong> exploits the task parallelization (including task dependencies)
available with OpenMP 4.5.
The main idea is to split the work in smaller units that can be run asynchronously,
respecting the logical order in which these units of work must be completed.</p>
<p>In addition to separated species treatment and patches split in clusters
(see <a class="reference internal" href="../Use/namelist.html#cluster_width" title="cluster_width"><code class="xref py py-data docutils literal notranslate"><span class="pre">cluster_width</span></code></a> and the following Figure), the macro-particle
operators (interpolation, push, etc) are defined as tasks.
All the combinations of [operator-cluster-species-patch]
correspond to different tasks that can be run in parallel.</p>
<figure class="align-center" id="id4">
<span id="cluster-definition-doc"></span><a class="reference internal image-reference" href="../_images/Cluster_definition_doc.png"><img alt="../_images/Cluster_definition_doc.png" src="../_images/Cluster_definition_doc.png" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 70 </span><span class="caption-text">Definition of clusters in a patch. The depicted 2D patch’s size is 16 × 6 cells
in the <cite>x</cite> and <cite>y</cite> directions respectively. In the Figure each cluster has an <cite>x</cite>
extension equal to <code class="docutils literal notranslate"><span class="pre">cluster_width</span> <span class="pre">=</span> <span class="pre">4</span></code> cells in the <cite>x</cite> direction.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<hr class="docutils" />
<section id="task-dependency-graph">
<h2>Task dependency graph<a class="headerlink" href="#task-dependency-graph" title="Permalink to this headline">¶</a></h2>
<p>Some tasks logically depend on other tasks, e.g. the position and momenta of the
macro-particles of a certain [cluster-species-patch] combination can be
advanced in a given iteration only after that the electromagnetic force acting
on them in that iteration has been interpolated from the grid.</p>
<p>The combinations [operator-cluster-species-patch] are defined as tasks, with
dependencies respecting the PIC macro-particle operator sequence
(Interpolation, Push, Projection) on the respective [cluster-species-patch]
combinations.</p>
<p>In task programming, the task dependencies of an algorithm are represented by
a task dependency graph, where each task is a node of the graph and the directed
edges between nodes are the task dependencies. If in this graph an arrow spawns
from task A to task B, then task B logically depends on task A.</p>
<p>In the code, the dependency graph is provided to OpenMP in form of <code class="docutils literal notranslate"><span class="pre">depend</span></code>
clauses in the <code class="docutils literal notranslate"><span class="pre">omp</span> <span class="pre">task</span></code> directives. This way, the tasks are dynamically assigned
to OpenMP threads, in the correct order (preventing data race conditions).
The user does not have to worry about the assignment of tasks to
the available threads, as this operation is done dynamically by the OpenMP scheduler.</p>
<p>This is described in <a class="reference internal" href="../Overview/material.html#massimo2022" id="id2"><span>[Massimo2022]</span></a>.</p>
</section>
<hr class="docutils" />
<section id="performance-results">
<h2>Performance Results<a class="headerlink" href="#performance-results" title="Permalink to this headline">¶</a></h2>
<p>Some results from <a class="reference internal" href="../Overview/material.html#massimo2022" id="id3"><span>[Massimo2022]</span></a> are shown in the following.</p>
<p>In the following Figure, a 2D uniform thermal plasma case shows that with
uniform macro-particle distributions the task-parallelization in <strong class="program">Smilei</strong>
does not have a performance advantage.
In the same Figure, a 2D radiation pressure acceleration case shows that task
parallelization can have a performance advantage with non-uniform macro-particle
distributions.</p>
<figure class="align-center" id="id5">
<span id="cluster-width-scan-doc"></span><a class="reference internal image-reference" href="../_images/Cluster_width_scan_doc.png"><img alt="../_images/Cluster_width_scan_doc.png" src="../_images/Cluster_width_scan_doc.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 71 </span><span class="caption-text">Performances with and without task parallelization in a 2D uniform plasma case
(left) and in a 2D radiation pressure acceleration case (right).</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>Note in the following Figure the non-uniformity of the electrons distribution
in the radiation pressure acceleration case. The non-uniformity is present since
the start of the simulation. A namelist for a similar case can be found in the
<code class="docutils literal notranslate"><span class="pre">benchmarks/tst2d_02_radiation_pressure_acc</span></code>.</p>
<figure class="align-center" id="id6">
<span id="radiation-pressure-rho"></span><a class="reference internal image-reference" href="../_images/Radiation_Pressure_Rho.png"><img alt="../_images/Radiation_Pressure_Rho.png" src="../_images/Radiation_Pressure_Rho.png" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 72 </span><span class="caption-text">Electron density divided by the critical density in a 2D radiation pressure
benchmark at 0 (left) and 1500 iterations (right). The non-uniformity of the
macro-particle distribution is present since the start of the simulation.</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The scheduling of macro-particle operations without and with task parallelization
can be seen in the following figures.
Note how in the first Figure (without task parallelization), the end of the
treatment of macro-particle operators (around 0.1 s) is determined by the
OpenMP thread 0 of the MPI process 0. In the second Figure (with task parallelization),
the OpemMP thread 2 of MPI process 0 determines the end of the
treatment of macro-particle operators (around 0.07 s). In this case, the finer
decomposition given by the clusters and the relaxation of the constraints involved
in the assignment of macro-particle operations to threads yields a shorter time
to the result.</p>
<figure class="align-center" id="id7">
<span id="part-event-tracing"></span><a class="reference internal image-reference" href="../_images/Task_tracing_doc.png"><img alt="../_images/Task_tracing_doc.png" src="../_images/Task_tracing_doc.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 73 </span><span class="caption-text">Scheduling of macro-particle operations for the 2D radiation pressure benchmark,
4 MPI processes and 4 OpenMP threads, during iteration 1200,
without (left panel) and with task parallelization, 4 clusters per patch (right panel).</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      <div>
        <input type="button" id="themebutton"  value="" onclick="switchTheme('')" />
      </div>
      <div>
      <a href="site.html">Site index</a>
      </div>
      <div>
        Last updated on Nov 19, 2024
      </div>
      
      <div>
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      </div>
      
    </div>
    
    <script type="text/javascript">
        
        var nav = document.getElementById("nav");
        var nav_list = document.getElementById("nav_list");
        var nav_button = document.getElementById("nav_button");
        var smallScreenMenu = document.getElementById("smallScreenMenu");
        var smallScreenMenuButton = document.getElementById("smallScreenMenuButton");
        var searchicon = document.getElementById("searchicon");
        var searchbox  = document.getElementById("searchbox");
        var searchinput= document.getElementById("searchinput");
        var menus = document.getElementsByClassName("menu");
        for( var i=0; i<menus.length; i++ )
            menus[i].active = false;
        
        // Manage theme
        var theme="light";
        function switchTheme(type) {
            if( type == "dark" || ( ! type && theme == "light" ) ) {
                theme = "dark";
                document.documentElement.setAttribute('theme', 'dark');
                window.name = "dark_theme"
                localStorage.setItem("_theme","dark")
            } else {
                theme = "light";
                document.documentElement.setAttribute('theme', 'light');
                window.name = "light_theme"
                localStorage.setItem("_theme","light")
            }
        }
        if( window.name && window.name == "light_theme" ) {
            switchTheme("light");
        } else if ( window.name && window.name == "dark_theme" ) {
            switchTheme("dark");
        } else if( stored_theme = localStorage.getItem("_theme") ) {
            switchTheme(stored_theme);
        } else if( window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
            switchTheme("dark");
        }
        
        var ul = nav_list.getElementsByTagName("ul")[0], li;
        var keep_nav = false;
        if( ul ) {
            li = ul.firstElementChild;
            if( li ) {
                if( li.getElementsByTagName("ul").length > 0 ) keep_nav = true;
            }
        }
        if( keep_nav ) {
            li.removeChild( li.firstElementChild );
        } else {
            document.getElementById("nav_positioner").removeChild( document.getElementById("nav") );
        }
        
        function navOff() {
            nav_list.style.display = "none";
            nav_button.className = "";
            nav.style.overflowY = "visible";
        }
        
        function toggleNav() {
            for( var i=0; i<menus.length; i++ )
                menuOff( menus[i] );
            if( nav_list.style.display != "inline-block" ) {
                nav_list.style.display = "inline-block";
                nav_button.className = "pushed";
                nav.style.overflowY = "auto";
            } else {
                navOff();
            }
        }
        
        function toggleSmallScreenMenu(e) {
            if( smallScreenMenu.className != "on" ) {
                smallScreenMenu.className = "on";
                smallScreenMenuButton.className = "pushed";
                document.documentElement.style.overflow = "hidden";
            } else {
                smallScreenMenu.className = "off";
                smallScreenMenuButton.className = "";
                document.documentElement.style.overflow = "";
            }
        }
        
        if (smallScreenMenuAfterTOC = document.getElementById("smallScreenMenuAfterTOC")) {
            var smallScreenMenuTOC = smallScreenMenuAfterTOC.previousElementSibling
                .getElementsByTagName("li")[0].getElementsByTagName("ul")[0].getElementsByTagName("li");
            for (var i = 0; i < smallScreenMenuTOC.length; i++) {
                if (smallScreenMenuTOC[i].tagName = "a") {
                    smallScreenMenuTOC[i].addEventListener("click", function(event){ toggleSmallScreenMenu(event); } );
                }
            }
        }
        
        function prepareMenu(menu_id) {
            var menu = document.getElementById(menu_id);
            menu.timer1 = setTimeout(function(a){ return function(){thisMenuOnly(a)};}(menu_id), 100);
            menu.addEventListener("mouseleave", function(a){ return function(){clearTimeout(a.timer1)};}(menu) );
        }
        
        function leaveMenu(menu_id, source) {
            var menu = document.getElementById(menu_id);
            menu.timer2 = setTimeout(function(a){ return function(){menuOff(a)};}(menu), 1000);
            source.addEventListener("mouseenter", function(a){ return function(){clearTimeout(a.timer2)};}(menu) );
        }
        
        function menuOn( menu ) {
            var divs = menu.getElementsByTagName("div");
            if(nav_list) navOff();
            divs[1].className = "on";
            divs[0].className = "menuButton pushed";
            menu.active = true;
        }
        function menuOff( menu ) {
            var divs = menu.getElementsByTagName("div");
            divs[1].className = "off";
            divs[0].className = "menuButton";
            menu.active = false;
        }
        
        function thisMenuOnly(menu_id) {
            var menu = document.getElementById(menu_id);
            for( var i=0; i<menus.length; i++ )
                if( i!=menu_id )
                    menuOff( menus[i] );
            menuOn( menu );
        }
        
        function toggleMenu(menu_id) {
            var menu = document.getElementById(menu_id);
            if( menu.active ) {
                menuOff( menu );
            } else {
                for( var i=0; i<menus.length; i++ )
                    if( i!=menu_id )
                        menuOff( menus[i] );
                menuOn( menu );
            }
        }
        
        function openSearch() {
            for( var i=0; i<menus.length; i++ ) {
                menuOff( menus[i] );
                menus[i].style.zIndex = "-1";
            }
            searchicon.style.display = "none";
            closesearchicon.style.display = "block";
            searchbox.style.display = "block";
            searchinput.focus();
        }
        
        function closeSearch() {
            searchicon.style.display = "block";
            closesearchicon.style.display = "none";
            searchbox .style.display = "none";
            for( var i=0; i<menus.length; i++ )
                menus[i].style.zIndex = "0";
        }
        
        
        var documentDiv = document.getElementsByClassName("document")[0];
        documentDiv.addEventListener('click', function (event) {
            if(nav_list) navOff();
            for( var i=0; i<menus.length; i++ )
                menuOff( menus[i] );
        });
    </script>
  </body>
</html>